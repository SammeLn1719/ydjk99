# WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Messager

## üöÄ –ß—Ç–æ –º—ã –¥–æ–±–∞–≤–∏–ª–∏

### Frontend (React + TypeScript)
- **WebSocket —Å–µ—Ä–≤–∏—Å** (`frontend/src/services/websocketService.ts`)
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —á–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º** - —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ
- **–°–æ–±—ã—Ç–∏—è –ø–µ—á–∞—Ç–∏** - "–ø–µ—á–∞—Ç–∞–µ—Ç..." –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### Backend (Node.js + Express)
- **WebSocket —Å–µ—Ä–≤–µ—Ä** (`backend/src/websocket/websocketServer.ts`)
- **Socket.IO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
- **–ß–∞—Ç-–∫–æ–º–Ω–∞—Ç—ã** - –∏–∑–æ–ª—è—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —á–∞—Ç–∞–º
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### Frontend
```bash
npm install @types/ws ws socket.io-client
```

### Backend
```bash
npm install ws @types/ws socket.io
```

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
```typescript
// –í ChatInterface.tsx
useEffect(() => {
  const connectToWebSocket = async () => {
    try {
      await websocketService.connect('user-1', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      setIsConnected(true);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket:', error);
    }
  };

  connectToWebSocket();
}, []);
```

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```typescript
const handleSendMessage = (text: string) => {
  if (!selectedContact || !isConnected) return;
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
  websocketService.sendMessage(selectedContact.id, text);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const newMessage = { /* ... */ };
  setMessages(prev => [...prev, newMessage]);
};
```

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
```typescript
const unsubscribeMessage = websocketService.onMessage((message: ChatMessage) => {
  if (selectedContact && message.chatId === selectedContact.id) {
    const newMessage = {
      id: message.id,
      text: message.text,
      senderId: message.senderId,
      timestamp: new Date(message.timestamp).toLocaleTimeString('ru-RU'),
      isOwn: message.senderId === 'user-1'
    };
    setMessages(prev => [...prev, newMessage]);
  }
});
```

### 4. –°–æ–±—ã—Ç–∏—è –ø–µ—á–∞—Ç–∏
```typescript
const unsubscribeTyping = websocketService.onTyping((event: TypingEvent) => {
  if (selectedContact && event.chatId === selectedContact.id) {
    if (event.isTyping) {
      setTypingUsers(prev => new Set(prev).add(event.userName));
    } else {
      setTypingUsers(prev => {
        const newSet = new Set(prev);
        newSet.delete(event.userName);
        return newSet;
      });
    }
  }
});
```

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ WebSocket —Å–µ—Ä–≤–∏—Å–∞

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `connect(userId, userName)` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
- `disconnect()` - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- `isConnected()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –°–æ–æ–±—â–µ–Ω–∏—è
- `sendMessage(chatId, text)` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- `onMessage(handler)` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `joinChat(chatId)` - –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —á–∞—Ç—É
- `leaveChat(chatId)` - –ø–æ–∫–∏–¥–∞–Ω–∏–µ —á–∞—Ç–∞

### –°–æ–±—ã—Ç–∏—è
- `sendTyping(chatId, isTyping)` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—á–∞—Ç–∏
- `onTyping(handler)` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–µ—á–∞—Ç–∏
- `onUserStatus(handler)` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `onConnectionChange(handler)` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```typescript
// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
this.socket = io('http://localhost:8001', {
  auth: {
    userId,
    userName
  }
});
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

## üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
- üü¢ **–ü–æ–¥–∫–ª—é—á–µ–Ω–æ** - WebSocket –∞–∫—Ç–∏–≤–µ–Ω
- üî¥ **–û—Ç–∫–ª—é—á–µ–Ω–æ** - WebSocket –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
- **–ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–ü–µ—á–∞—Ç–∞–µ—Ç...** - –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
- **–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω

## üõ† –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –≤ `websocketService.ts`
2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ `websocketServer.ts`
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –û—Ç–ª–∞–¥–∫–∞
```typescript
// –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏ WebSocket
console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', message);
console.log('–û—à–∏–±–∫–∞ WebSocket:', error);
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] **–ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] **–§–∞–π–ª—ã –∏ –º–µ–¥–∏–∞** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- [ ] **–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** - –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] **–°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏** - –ø—Ä–æ—á–∏—Ç–∞–Ω–æ/–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- [ ] **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] **–°–∂–∞—Ç–∏–µ** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
- [ ] **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Socket.IO –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://socket.io/docs/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [React useEffect](https://react.dev/reference/react/useEffect)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º –∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.

